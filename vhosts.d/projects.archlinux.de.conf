server {
	server_name projects.archlinux.de;

	root /srv/http/vhosts/projects.archlinux.de/htdocs;
	access_log /var/log/nginx/projects.archlinux.de-access.log;
	error_log /var/log/nginx/projects.archlinux.de-error.log;

	include hosts.d/archlinux.de.conf;

	location = /cgit.css {
		alias /usr/share/webapps/cgit/cgit.css;
		expires 2M;
	}
	location = /cgit.png {
		alias /usr/share/webapps/cgit/cgit.png;
		expires 2M;
	}
	location = /arch.css {
		alias /srv/http/vhosts/www.archlinux.de/htdocs/style/arch.css;
		expires 2M;
	}
	location = /archlogo.gif {
		alias /srv/http/vhosts/www.archlinux.de/htdocs/style/archlogo.gif;
		expires 2M;
	}
	location = /archlogo.png {
		alias /srv/http/vhosts/www.archlinux.de/htdocs/style/archlogo.png;
		expires 2M;
	}
	location = /archnavbar.css {
		alias /srv/http/vhosts/www.archlinux.de/htdocs/style/archnavbar.css;
		expires 2M;
	}
	location = /favicon.ico {
		alias /srv/http/vhosts/www.archlinux.de/htdocs/style/favicon.ico;
		expires 2M;
	}
	location = /archcgit.css {
		expires 2M;
	}

	location ~ "^/www\.archlinux\.de\.git(.*)$" {
		return 301 https://projects.archlinux.de/archportal.git$1;
	}

	location ~ "^/repo-tools\.git(.*)$" {
		return 301 https://projects.pierre-schmitz.com/repo-tools.git$1;
	}

	location /cgit.cgi {
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME /usr/lib/cgit/cgit.cgi;
		fastcgi_param CGIT_CONFIG /srv/http/vhosts/projects.archlinux.de/cgitrc;
		fastcgi_pass unix:/run/fcgiwrap/cgit-al.socket;
	}

	rewrite ^/([^?/]+/[^?]*)?(?:\?(.*))?$ /cgit.cgi?url=$1&$2;
}
